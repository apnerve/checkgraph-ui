// Generated by CoffeeScript 1.3.3
var CheckGraph;

CheckGraph = (function() {
  var addConnectionOnServer, addNewTask, graphId, handleClass, handleGraphics, initGraph, initTasksObj, isAcyclic, levels, markTaskAs, populateLevels, tasks, tasksCleanup, tasksCount, title, urls;

  urls = {
    addChild: function(parentId, childId) {
      return "addChild.html?&graph_id=" + graphId + "&parent_id=" + parentId + "&child_id" + childId;
    },
    changeStatus: function(taskId, status) {
      return "changeStatus.php?&graph_id=" + graphId + "&task_id=" + taskId + "&status=" + status;
    },
    createTask: function(name) {
      return ("createTask.php?graph_id=" + graphId + "&name=") + encodeURIComponent(name);
    }
  };

  graphId = null;

  title = null;

  tasks = {};

  tasksCount = 0;

  levels = [];

  addConnectionOnServer = function(parentId, childId, drawer) {
    var errorHandle;
    errorHandle = function(response) {
      console.log("Error");
      console.log(response);
      return tasks[parentId].children = tasks[parentId].children.slice(0, tasks[parentId].children.length - 1);
    };
    return $.ajax({
      url: urls.addChild(parentId, childId),
      method: 'get',
      success: function(response) {
        if (response.status === 200 || true) {
          if (drawer != null) {
            drawer(parentId, childId);
          }
          console.log("success");
          tasksCleanup();
          populateLevels();
          handleGraphics(true);
        } else {
          errorHandle(response);
        }
        return console.log(response);
      },
      complete: $(".ButtonSelected").removeClass("ButtonSelected"),
      error: function(response) {
        return errorHandle(response);
      }
    });
  };

  tasksCleanup = function() {
    var cleanup, id, task, _i, _len, _results;
    cleanup = function(taskId) {
      tasks[taskId].DOMItem = null;
      tasks[taskId].Raphael = null;
      return tasks[taskId].isOpen = null;
    };
    _results = [];
    for (task = _i = 0, _len = tasks.length; _i < _len; task = ++_i) {
      id = tasks[task];
      _results.push(cleanup(id));
    }
    return _results;
  };

  addNewTask = function(connectedTo, isChild) {
    $("#myModal h1").html("Add a new Task");
    $("#myModal input[type=submit]").off();
    $("#myModal input[type=submit]").click(function(event) {
      var name, url;
      event.preventDefault();
      name = $("#myModal input[type=text]").val();
      url = urls.createTask(name);
      return $.get(url).success(function(response) {
        tasks[response.task.id] = response.task;
        if (connectedTo != null) {
          if (isChild) {
            tasks[connectedTo].children.push({
              id: response.task.id
            });
            addConnectionOnServer(connectedTo, response.task.id);
          } else {
            console.log("Here");
            tasks[response.task.id].children.push({
              id: connectedTo
            });
            addConnectionOnServer(response.task.id, connectedTo);
          }
        }
        console.log(tasks.valueOf());
        tasksCount += 1;
        tasksCleanup();
        populateLevels();
        return handleGraphics();
      }).error(function(response) {
        return console.log("Unable to create Task");
      }).complete(function() {
        return $("#myModal").trigger('reveal:close');
      });
    });
    return $("#myModal").reveal();
  };

  handleClass = function(obj, isDone, isOpen) {
    var h;
    h = function(add, remove) {
      var cls, _i, _j, _len, _len1, _results;
      for (_i = 0, _len = add.length; _i < _len; _i++) {
        cls = add[_i];
        obj.addClass(cls);
      }
      _results = [];
      for (_j = 0, _len1 = remove.length; _j < _len1; _j++) {
        cls = remove[_j];
        _results.push(obj.removeClass(cls));
      }
      return _results;
    };
    if (isDone) {
      return h(["done-task", "blue"], ["open-task", "red", "yellow"]);
    } else if (isOpen) {
      return h(["open-task", "red"], ["done-task", "blue", "yellow"]);
    } else {
      return h(["yellow"], ["open-task", "done-task", "blue", "red"]);
    }
  };

  markTaskAs = function(taskId, newStatus) {
    var checkIfOpen, markTaskAsDone, oldStatus;
    checkIfOpen = function(taskId) {
      var id, isOpen, shouldMarkFalse, task;
      isOpen = true;
      shouldMarkFalse = function(parentId, parent) {
        var child, isParent, markParent, _i, _len, _ref;
        isParent = false;
        markParent = function(childId) {
          if (String(childId) === String(taskId)) {
            return isParent = true;
          }
        };
        _ref = parent.children;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          child = _ref[_i];
          markParent(child.id);
        }
        if (isParent && tasks[parentId].status !== "DONE") {
          return isOpen = false;
        }
      };
      for (id in tasks) {
        task = tasks[id];
        shouldMarkFalse(id, task);
      }
      if (isOpen && !tasks[taskId].isOpen) {
        tasks[taskId].isOpen = true;
        return handleClass(tasks[taskId].DOMItem, false, true);
      }
    };
    markTaskAsDone = function() {
      return $.ajax({
        url: urls.changeStatus(taskId, "DONE"),
        method: "GET",
        success: function(response) {
          var child, _i, _len, _ref, _results;
          console.log("Marked Done");
          tasks[taskId].status = "DONE";
          handleClass(tasks[taskId].DOMItem, true, true);
          _ref = tasks[taskId].children;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            child = _ref[_i];
            _results.push(checkIfOpen(child.id));
          }
          return _results;
        },
        error: function(response) {
          return console.log("Unable to Mark Done");
        },
        complete: function(response) {
          return console.log("Completed");
        }
      });
    };
    oldStatus = tasks[taskId].status;
    if (oldStatus !== newStatus) {
      if (oldStatus === "NOT_DONE" && tasks[taskId].isOpen && newStatus === "DONE") {
        return markTaskAsDone();
      }
    }
  };

  initTasksObj = function(taskList) {
    var addTask, task, _i, _len, _results;
    tasksCount = taskList.length;
    addTask = function(task) {
      return tasks[task.id] = task;
    };
    _results = [];
    for (_i = 0, _len = taskList.length; _i < _len; _i++) {
      task = taskList[_i];
      _results.push(addTask(task));
    }
    return _results;
  };

  populateLevels = function() {
    var id, initTask, isLeveled, leveledCount, markThisLevel, markUsingTask, num, remarkTasks, task, taskStatus;
    taskStatus = {};
    isLeveled = {};
    levels = [];
    leveledCount = 0;
    markUsingTask = function(id, task) {
      var child, lockTask, markAs, _i, _j, _len, _len1, _ref, _ref1, _results;
      markAs = function(task_id, isParent) {
        if (!(taskStatus[task_id] != null)) {
          return taskStatus[task_id] = isParent ? "Parent" : "Child";
        } else if (taskStatus[task_id] === "Parent" && isParent === false) {
          return taskStatus[task_id] = "Child";
        }
      };
      lockTask = function(task_id) {
        return tasks[task_id].isOpen = false;
      };
      if (taskStatus[id] === "Leveled") {
        return;
      }
      markAs(id, true);
      _ref = task.children;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        markAs(child.id, false);
      }
      if (task.status === "NOT_DONE") {
        _ref1 = task.children;
        _results = [];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          child = _ref1[_j];
          _results.push(lockTask(child.id));
        }
        return _results;
      }
    };
    remarkTasks = function() {
      var id, remark, task, _results;
      remark = function(id) {
        if (taskStatus[id] !== "Leveled") {
          return taskStatus[id] = "Parent";
        }
      };
      _results = [];
      for (id in taskStatus) {
        task = taskStatus[id];
        _results.push(remark(id));
      }
      return _results;
    };
    markThisLevel = function() {
      var handleTaskLeveling, id, status, thisLevel;
      thisLevel = [];
      handleTaskLeveling = function(task_id, status) {
        if (status === "Parent") {
          thisLevel.push(task_id);
          return taskStatus[task_id] = "Leveled";
        }
      };
      for (id in taskStatus) {
        status = taskStatus[id];
        handleTaskLeveling(id, status);
      }
      levels.push(thisLevel);
      leveledCount = leveledCount + thisLevel.length;
      return thisLevel.length;
    };
    initTask = function(id) {
      isLeveled[id] = false;
      return tasks[id].isOpen = true;
    };
    for (id in tasks) {
      task = tasks[id];
      initTask(id);
    }
    while (leveledCount < tasksCount) {
      for (id in tasks) {
        task = tasks[id];
        markUsingTask(id, task);
      }
      num = markThisLevel();
      if (num === 0) {
        console.log("This is a cyclic graph.");
        return false;
      }
      remarkTasks();
    }
    return true;
  };

  handleGraphics = function(cleanup) {
    var addChildConnection, canvasWidth, connectionClickHandle, connectionClickStatus, connectionDrawer, dataContainer, drawLevel, height, id, level, paper, task, width, xOffSet, xSpace, yOffSet, ySpace, yTextOffSet, _i, _len, _results;
    canvasWidth = levels.length * 470;
    if ((cleanup != null) && cleanup === true) {
      $("#background-canvas").empty();
      $("#foreground-data").empty();
    }
    paper = Raphael("background-canvas", "" + canvasWidth + "px", "100%");
    height = 105;
    width = 335;
    xSpace = 135;
    ySpace = 33;
    xOffSet = 65;
    yOffSet = ySpace + 2;
    yTextOffSet = 30;
    dataContainer = $("#foreground-data");
    connectionDrawer = function(parent, child) {
      return paper.connection(tasks[parent].Raphael.rObj, tasks[child].Raphael.rObj, 2, "#400");
    };
    connectionClickStatus = {
      active: false,
      taskId: null,
      type: null
    };
    connectionClickHandle = function(taskId, type, drawer) {
      var childId, newChildRef, parentId;
      if (!connectionClickStatus.active) {
        connectionClickStatus.active = true;
        connectionClickStatus.taskId = taskId;
        return connectionClickStatus.type = type;
      } else {
        if (connectionClickStatus.type === type) {
          console.log("Same Type! Couldn't connect");
        } else if (connectionClickStatus.taskId === taskId) {
          console.log("Same Task! Couldn't connect");
        } else {
          parentId = type === "right" ? taskId : connectionClickStatus.taskId;
          childId = type === "left" ? taskId : connectionClickStatus.taskId;
          newChildRef = {
            id: childId
          };
          tasks[parentId].children.push(newChildRef);
          if (populateLevels()) {
            addConnectionOnServer(parentId, childId, connectionDrawer);
          } else {
            tasks[parentId].children = tasks[parentId].children.slice(0, tasks[parentId].children.length - 1);
            $(".ButtonSelected").removeClass("ButtonSelected");
          }
        }
        return connectionClickStatus.active = false;
      }
    };
    drawLevel = function(level) {
      var column, drawTask, taskId, _i, _len;
      yOffSet = ySpace;
      column = $("<div></div>").addClass("takswrap");
      dataContainer.append(column);
      drawTask = function(taskId) {
        var doneLink, item, leftLinks, rightLinks;
        item = $("<div></div>").addClass("todo-app");
        item.append($("<div class='maintask'>" + tasks[taskId].name + "</div>"));
        tasks[taskId].DOMItem = item;
        handleClass(item, tasks[taskId].status === "DONE", tasks[taskId].isOpen);
        doneLink = function() {
          var con, doneButton;
          con = $("<div></div>").addClass("actions");
          doneButton = function() {
            var but;
            but = $("<input type='submit' value='Done'>");
            return but.click(function() {
              return markTaskAs(taskId, "DONE");
            });
          };
          con.append(doneButton());
          return con;
        };
        rightLinks = function() {
          var con, rightArrow, rightButton;
          con = $("<div class='addLinks'></div>");
          rightArrow = function() {
            var ele;
            ele = $('<input type="submit" value=">" />');
            ele.click(function() {
              ele.addClass("ButtonSelected");
              return connectionClickHandle(taskId, "right");
            });
            return ele;
          };
          rightButton = function() {
            var ele;
            ele = $('<input type="submit" value="+" />');
            ele.click(function() {
              return addNewTask(taskId, true);
            });
            return ele;
          };
          con.append(rightArrow());
          con.append(rightButton());
          return con;
        };
        leftLinks = function() {
          var con, leftArrow, leftButton;
          leftArrow = function() {
            var ele;
            ele = $('<input type="submit" value="<" />');
            ele.click(function() {
              ele.addClass("ButtonSelected");
              return connectionClickHandle(taskId, "left");
            });
            return ele;
          };
          leftButton = function() {
            var ele;
            ele = $('<input type="submit" value="+" />');
            ele.click(function() {
              return addNewTask(taskId, false);
            });
            return ele;
          };
          con = $("<div class='addLinks leftlink'></div>");
          con.append(leftArrow());
          return con.append(leftButton());
        };
        item.append(doneLink());
        item.append(rightLinks());
        item.append(leftLinks());
        tasks[taskId].Raphael = {
          rObj: paper.rect(xOffSet, yOffSet, width, height),
          taskDataItem: item
        };
        yOffSet = yOffSet + height + ySpace;
        return column.append(item);
      };
      for (_i = 0, _len = level.length; _i < _len; _i++) {
        taskId = level[_i];
        drawTask(taskId);
      }
      return xOffSet = xOffSet + width + xSpace;
    };
    addChildConnection = function(id, task) {
      var addConnection, child, _i, _len, _ref, _results;
      addConnection = function(obj1, obj2) {
        return paper.connection(obj1, obj2, 2, "#400");
      };
      _ref = task.children;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        _results.push(addConnection(task.Raphael.rObj, tasks[child.id].Raphael.rObj));
      }
      return _results;
    };
    for (_i = 0, _len = levels.length; _i < _len; _i++) {
      level = levels[_i];
      drawLevel(level);
    }
    _results = [];
    for (id in tasks) {
      task = tasks[id];
      _results.push(addChildConnection(id, task));
    }
    return _results;
  };

  initGraph = function() {
    populateLevels();
    return window.onload = function() {
      return handleGraphics();
    };
  };

  isAcyclic = function() {};

  function CheckGraph(graphObj) {
    title = graphObj.title;
    initTasksObj(graphObj.tasks);
    initGraph();
  }

  return CheckGraph;

})();
